

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามงานติดตั้งและซ่อมบำรุง</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f8f9fa;
        }
        .bg-pastel-blue {
            background-color: #b8d8e8;
        }
        .bg-pastel-cream {
            background-color: #f9f3e6;
        }
        .bg-pastel-orange {
            background-color: #ffcba4;
        }
        .text-pastel-blue {
            color: #5a9bc7;
        }
        .border-pastel-blue {
            border-color: #b8d8e8;
        }
        .status-assigned {
            background-color: #fff2cc;
        }
        .status-inprogress {
            background-color: #f8d7da;
        }
        .status-completed {
            background-color: #d4edda;
        }
        .nav-item {
            transition: all 0.3s ease;
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.3);
            font-weight: 500;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
        }
        th {
            background-color: #b8d8e8;
            color: #2d3748;
            font-weight: 500;
        }
        tr:nth-child(even) {
            background-color: #f9f3e6;
        }
        tr:hover {
            background-color: #edf2f7;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-pastel-blue shadow-md">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <h1 class="text-xl font-semibold text-white">ระบบติดตามงานติดตั้งและซ่อมบำรุง</h1>
                </div>
                <div class="flex items-center">
                    <button id="refreshBtn" class="mr-4 bg-white text-pastel-blue p-2 rounded-full hover:bg-gray-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                    <button id="settingsBtn" class="bg-white text-pastel-blue p-2 rounded-full hover:bg-gray-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-pastel-orange shadow-md">
            <div class="container mx-auto px-4">
                <div class="flex space-x-1">
                    <button class="nav-item active py-3 px-6 text-white rounded-t-md" data-page="dashboard">หน้าแดชบอร์ด</button>
                    <button class="nav-item py-3 px-6 text-white rounded-t-md" data-page="tasks">รายการมอบหมายงาน</button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow bg-pastel-cream">
            <div class="container mx-auto px-4 py-6">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-xl font-semibold mb-4 text-pastel-blue">สรุปข้อมูลงานซ่อมบำรุง</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-pastel-blue bg-opacity-20 rounded-lg p-4 text-center">
                                <h3 class="text-lg font-medium mb-2">งานทั้งหมด</h3>
                                <p id="total-tasks" class="text-3xl font-bold text-pastel-blue">0</p>
                            </div>
                            <div class="bg-yellow-100 rounded-lg p-4 text-center">
                                <h3 class="text-lg font-medium mb-2">รอดำเนินการ</h3>
                                <p id="pending-tasks" class="text-3xl font-bold text-yellow-600">0</p>
                            </div>
                            <div class="bg-green-100 rounded-lg p-4 text-center">
                                <h3 class="text-lg font-medium mb-2">ดำเนินการเสร็จสิ้น</h3>
                                <p id="completed-tasks" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg shadow p-4">
                                <h3 class="text-lg font-medium mb-4">ประเภทงานที่รับแจ้ง</h3>
                                <div class="chart-container">
                                    <canvas id="issueTypeChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-4">
                                <h3 class="text-lg font-medium mb-4">สถานะงานตามผู้รับผิดชอบ</h3>
                                <div class="chart-container">
                                    <canvas id="responsibleChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-pastel-blue">รายการงานทั้งหมด</h2>
                            <div class="flex space-x-2">
                                <div class="relative">
                                    <input type="date" id="filter-date" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pastel-blue">
                                </div>
                                <div class="relative">
                                    <select id="filter-issue" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pastel-blue">
                                        <option value="">เลือกประเภทงาน</option>
                                    </select>
                                </div>
                                <button id="clear-filters" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition">ล้างตัวกรอง</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr>
                                        <th>วันที่รับแจ้ง</th>
                                        <th>เรื่องที่รับแจ้ง</th>
                                        <th>สถานที่</th>
                                        <th>รายละเอียด</th>
                                        <th>ผู้รับผิดชอบ</th>
                                        <th>สถานะ</th>
                                        <th>ผลการปฏิบัติงาน</th>
                                        <th>วันที่ดำเนินการซ่อม</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboard-table-body">
                                    <!-- Data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tasks Page -->
                <div id="tasks-page" class="page hidden">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <ul class="flex border-b">
                            <li class="mr-1">
                                <button class="task-tab active bg-pastel-blue text-white py-2 px-4 rounded-t-md" data-tab="pending">รายการมอบหมายงาน</button>
                            </li>
                            <li class="mr-1">
                                <button class="task-tab bg-gray-200 text-gray-700 py-2 px-4 rounded-t-md" data-tab="completed">รายการดำเนินการเสร็จสิ้น</button>
                            </li>
                        </ul>
                        
                        <!-- Pending Tasks Tab -->
                        <div id="pending-tab" class="task-content mt-4">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr>
                                            <th>วันที่รับแจ้ง</th>
                                            <th>เรื่องที่รับแจ้ง</th>
                                            <th>สถานที่</th>
                                            <th>เบอร์โทรศัพท์</th>
                                            <th>รายละเอียด</th>
                                            <th>ผู้รับผิดชอบ</th>
                                            <th>สถานะ</th>
                                            <th>การดำเนินการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pending-table-body">
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Completed Tasks Tab -->
                        <div id="completed-tab" class="task-content mt-4 hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr>
                                            <th>วันที่รับแจ้ง</th>
                                            <th>เรื่องที่รับแจ้ง</th>
                                            <th>สถานที่</th>
                                            <th>ผู้รับผิดชอบ</th>
                                            <th>ผลการปฏิบัติงาน</th>
                                            <th>วันที่ดำเนินการซ่อม</th>
                                            <th>เวลาที่ซ่อมเสร็จ</th>
                                            <th>หมายเหตุ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="completed-table-body">
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-pastel-blue py-4">
            <div class="container mx-auto px-4 text-center text-white">
                <p>© 2024 ระบบติดตามงานติดตั้งและซ่อมบำรุง (Maintenance Tracking System)</p>
            </div>
        </footer>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-pastel-blue">ตั้งค่าระบบ</h3>
                <button id="close-settings" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="password">รหัสผ่าน</label>
                <input type="password" id="settings-password" class="border border-gray-300 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-pastel-blue" placeholder="กรอกรหัสผ่าน">
            </div>
            <div id="settings-content" class="hidden">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="sheet-id">Google Sheet ID</label>
                    <input type="text" id="sheet-id" class="border border-gray-300 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-pastel-blue" placeholder="กรอก Sheet ID">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="sheet-name">ชื่อหน้า Sheet</label>
                    <input type="text" id="sheet-name" class="border border-gray-300 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-pastel-blue" placeholder="กรอกชื่อหน้า Sheet">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="app-script-url">App Script URL</label>
                    <input type="text" id="app-script-url" class="border border-gray-300 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-pastel-blue" placeholder="กรอก URL ของ App Script">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="refresh-interval">เวลาอัพเดตอัตโนมัติ (นาที)</label>
                    <input type="number" id="refresh-interval" class="border border-gray-300 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-pastel-blue" min="1" placeholder="กรอกเวลาในการอัพเดต">
                </div>
                <div class="flex justify-end">
                    <button id="save-settings" class="bg-pastel-blue text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">บันทึกการตั้งค่า</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Action Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="task-modal-title" class="text-xl font-semibold text-pastel-blue">รับงาน</h3>
                <button id="close-task-modal" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="task-details" class="mb-4">
                <p><strong>เรื่องที่รับแจ้ง:</strong> <span id="task-issue"></span></p>
                <p><strong>สถานที่:</strong> <span id="task-location"></span></p>
                <p><strong>รายละเอียด:</strong> <span id="task-description"></span></p>
            </div>
            <div id="task-result-container" class="mb-4 hidden">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="task-result">ผลการปฏิบัติงาน/สาเหตุ *</label>
                <textarea id="task-result" class="border border-gray-300 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-pastel-blue" rows="3" placeholder="กรอกผลการปฏิบัติงาน/สาเหตุ"></textarea>
                <p id="result-error" class="text-red-500 text-xs italic hidden">กรุณากรอกผลการปฏิบัติงาน/สาเหตุ</p>
            </div>
            <div id="task-note-container" class="mb-4 hidden">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="task-note">หมายเหตุ</label>
                <textarea id="task-note" class="border border-gray-300 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-pastel-blue" rows="2" placeholder="กรอกหมายเหตุ (ถ้ามี)"></textarea>
            </div>
            <div class="flex justify-end">
                <button id="confirm-task-action" class="bg-pastel-blue text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">ยืนยัน</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sheetData = [];
        let currentTaskRow = null;
        let currentTaskAction = null;
        let refreshInterval = null;
        
        // Default settings
        const defaultSettings = {
            sheetId: '1q7knxk9LtPOWRpyAJoVdrDWxQMxQgQrgFJRN-H3fpNE',
            sheetName: 'รายงานการปฏิบัติงาน',
            appScriptUrl: 'https://script.google.com/macros/s/AKfycbz_emwaZiWmr7yGtknJUDEmx-v_-TpliOzTIPgnMMfLt0l1TOxAhwbmCp-l9ehkho7k/exec',
            refreshIntervalMinutes: 3
        };
        
        // Charts
        let issueTypeChart = null;
        let responsibleChart = null;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load settings from localStorage or use defaults
            loadSettings();
            
            // Set up event listeners
            setupEventListeners();
            
            // Load data from Google Sheets
            fetchSheetData();
            
            // Set up auto-refresh
            setupAutoRefresh();
        });
        
        // Load settings from localStorage
        function loadSettings() {
            const savedSettings = JSON.parse(localStorage.getItem('maintenanceTrackingSettings')) || {};
            
            // Merge saved settings with defaults
            const settings = {
                ...defaultSettings,
                ...savedSettings
            };
            
            // Update form fields
            document.getElementById('sheet-id').value = settings.sheetId;
            document.getElementById('sheet-name').value = settings.sheetName;
            document.getElementById('app-script-url').value = settings.appScriptUrl;
            document.getElementById('refresh-interval').value = settings.refreshIntervalMinutes;
            
            return settings;
        }
        
        // Save settings to localStorage
        function saveSettings() {
            const settings = {
                sheetId: document.getElementById('sheet-id').value,
                sheetName: document.getElementById('sheet-name').value,
                appScriptUrl: document.getElementById('app-script-url').value,
                refreshIntervalMinutes: parseInt(document.getElementById('refresh-interval').value) || defaultSettings.refreshIntervalMinutes
            };
            
            localStorage.setItem('maintenanceTrackingSettings', JSON.stringify(settings));
            
            // Update auto-refresh interval
            setupAutoRefresh();
            
            return settings;
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.dataset.page;
                    showPage(page);
                });
            });
            
            // Task tabs
            document.querySelectorAll('.task-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    showTaskTab(tabId);
                });
            });
            
            // Settings modal
            document.getElementById('settingsBtn').addEventListener('click', showSettingsModal);
            document.getElementById('close-settings').addEventListener('click', hideSettingsModal);
            document.getElementById('settings-password').addEventListener('keyup', checkSettingsPassword);
            document.getElementById('save-settings').addEventListener('click', function() {
                saveSettings();
                fetchSheetData();
                hideSettingsModal();
                Swal.fire({
                    title: 'บันทึกการตั้งค่าสำเร็จ',
                    icon: 'success',
                    confirmButtonColor: '#5a9bc7'
                });
            });
            
            // Task modal
            document.getElementById('close-task-modal').addEventListener('click', hideTaskModal);
            document.getElementById('confirm-task-action').addEventListener('click', confirmTaskAction);
            
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', fetchSheetData);
            
            // Filters
            document.getElementById('filter-date').addEventListener('change', applyFilters);
            document.getElementById('filter-issue').addEventListener('change', applyFilters);
            document.getElementById('clear-filters').addEventListener('click', clearFilters);
        }
        
        // Show page
        function showPage(page) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.page === page) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Show selected page, hide others
            document.querySelectorAll('.page').forEach(pageEl => {
                if (pageEl.id === `${page}-page`) {
                    pageEl.classList.remove('hidden');
                } else {
                    pageEl.classList.add('hidden');
                }
            });
        }
        
        // Show task tab
        function showTaskTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.task-tab').forEach(tab => {
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active', 'bg-pastel-blue', 'text-white');
                    tab.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    tab.classList.remove('active', 'bg-pastel-blue', 'text-white');
                    tab.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
            
            // Show selected tab content, hide others
            document.querySelectorAll('.task-content').forEach(content => {
                if (content.id === `${tabId}-tab`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        }
        
        // Show settings modal
        function showSettingsModal() {
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('settings-password').value = '';
            document.getElementById('settings-content').classList.add('hidden');
        }
        
        // Hide settings modal
        function hideSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }
        
        // Check settings password
        function checkSettingsPassword() {
            const password = document.getElementById('settings-password').value;
            if (password === 'satta2533') {
                document.getElementById('settings-content').classList.remove('hidden');
            } else {
                document.getElementById('settings-content').classList.add('hidden');
            }
        }
        
        // Show task modal
        function showTaskModal(row, action) {
            currentTaskRow = row;
            currentTaskAction = action;
            
            const modal = document.getElementById('task-modal');
            const title = document.getElementById('task-modal-title');
            const issue = document.getElementById('task-issue');
            const location = document.getElementById('task-location');
            const description = document.getElementById('task-description');
            const resultContainer = document.getElementById('task-result-container');
            const noteContainer = document.getElementById('task-note-container');
            const confirmButton = document.getElementById('confirm-task-action');
            
            // Set modal content
            if (action === 'accept') {
                title.textContent = 'รับงาน';
                confirmButton.textContent = 'รับงาน';
                resultContainer.classList.add('hidden');
                noteContainer.classList.add('hidden');
            } else if (action === 'complete') {
                title.textContent = 'ปิดงาน';
                confirmButton.textContent = 'ปิดงาน';
                resultContainer.classList.remove('hidden');
                noteContainer.classList.remove('hidden');
            }
            
            issue.textContent = sheetData[row][2] || '-';
            location.textContent = sheetData[row][3] || '-';
            description.textContent = sheetData[row][5] || '-';
            
            // Reset form fields
            document.getElementById('task-result').value = '';
            document.getElementById('task-note').value = '';
            document.getElementById('result-error').classList.add('hidden');
            
            modal.classList.remove('hidden');
        }
        
        // Hide task modal
        function hideTaskModal() {
            document.getElementById('task-modal').classList.add('hidden');
            currentTaskRow = null;
            currentTaskAction = null;
        }
        
        // Confirm task action
        function confirmTaskAction() {
            if (!currentTaskRow || !currentTaskAction) return;
            
            if (currentTaskAction === 'accept') {
                // Accept task
                updateTaskStatus(currentTaskRow, 'รับงาน/กำลังดำเนินงาน');
            } else if (currentTaskAction === 'complete') {
                // Complete task
                const result = document.getElementById('task-result').value.trim();
                const note = document.getElementById('task-note').value.trim();
                
                if (!result) {
                    document.getElementById('result-error').classList.remove('hidden');
                    return;
                }
                
                const today = new Date();
                const dateStr = formatDate(today);
                const timeStr = formatTime(today);
                
                updateTaskCompletion(currentTaskRow, result, dateStr, timeStr, note);
            }
            
            hideTaskModal();
        }
        
        // Format date as DD/MM/YYYY
        function formatDate(date) {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Format time as HH:MM
        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Set up auto-refresh
        function setupAutoRefresh() {
            // Clear existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // Get refresh interval from settings
            const settings = loadSettings();
            const intervalMinutes = settings.refreshIntervalMinutes;
            
            // Set new interval
            refreshInterval = setInterval(fetchSheetData, intervalMinutes * 60 * 1000);
        }
        
        // Fetch data from Google Sheets
        function fetchSheetData() {
            const settings = loadSettings();
            
            // Show loading indicator
            Swal.fire({
                title: 'กำลังโหลดข้อมูล',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Use the App Script to fetch data
            fetch(`${settings.appScriptUrl}?action=getData&sheetId=${settings.sheetId}&sheetName=${encodeURIComponent(settings.sheetName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        sheetData = data.data;
                        
                        // Update UI
                        updateDashboard();
                        updateTaskLists();
                        updateFilters();
                        
                        // Close loading indicator
                        Swal.close();
                    } else {
                        throw new Error(data.error || 'Failed to fetch data');
                    }
                })
                .catch(error => {
                    console.error('Error fetching sheet data:', error);
                    
                    // Show error message
                    Swal.fire({
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถโหลดข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
                        icon: 'error',
                        confirmButtonColor: '#5a9bc7'
                    });
                    
                    // Use sample data for demonstration
                    useSampleData();
                });
        }
        
        // Use sample data for demonstration
        function useSampleData() {
            sheetData = [
                ["1/7/2024", "", "ซ่อมแอร์", "ห้องประชุม A", "0812345678", "แอร์ไม่เย็น", "นายสมชาย", "มอบหมายงาน", "", "", "", ""],
                ["2/7/2024", "", "ซ่อมไฟ", "ห้องทำงาน B", "0823456789", "ไฟดับบ่อย", "นายสมศักดิ์", "รับงาน/กำลังดำเนินงาน", "", "", "", ""],
                ["3/7/2024", "", "ซ่อมประตู", "ทางเข้าอาคาร", "0834567890", "ประตูปิดไม่สนิท", "นายสมชาย", "ดำเนินการเสร็จสิ้น", "เปลี่ยนบานพับประตู", "5/7/2024", "14:30", ""],
                ["4/7/2024", "", "ซ่อมเครื่องปริ้นเตอร์", "ฝ่ายบุคคล", "0845678901", "ปริ้นไม่ออก", "นายสมศักดิ์", "มอบหมายงาน", "", "", "", ""],
                ["5/7/2024", "", "ซ่อมโต๊ะ", "ห้องประชุม B", "0856789012", "ขาโต๊ะหัก", "นายสมชัย", "ดำเนินการเสร็จสิ้น", "เปลี่ยนขาโต๊ะใหม่", "6/7/2024", "10:15", ""]
            ];
            
            // Update UI
            updateDashboard();
            updateTaskLists();
            updateFilters();
            
            // Close loading indicator
            Swal.close();
            
            // Show sample data message
            Swal.fire({
                title: 'ใช้ข้อมูลตัวอย่าง',
                text: 'ไม่สามารถเชื่อมต่อกับ Google Sheets ได้ จึงแสดงข้อมูลตัวอย่าง',
                icon: 'info',
                confirmButtonColor: '#5a9bc7'
            });
        }
        
        // Update dashboard
        function updateDashboard() {
            // Filter valid rows
            const validRows = sheetData.filter(row => {
                return row[0] && row[2] && row[3] && row[7]; // Check if date, issue, location, and status are not empty
            });
            
            // Count tasks by status
            const totalTasks = validRows.length;
            const pendingTasks = validRows.filter(row => row[7] === 'มอบหมายงาน' || row[7] === 'รับงาน/กำลังดำเนินงาน').length;
            const completedTasks = validRows.filter(row => row[7] === 'ดำเนินการเสร็จสิ้น').length;
            
            // Update counters
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('pending-tasks').textContent = pendingTasks;
            document.getElementById('completed-tasks').textContent = completedTasks;
            
            // Update dashboard table
            updateDashboardTable(validRows);
            
            // Update charts
            updateIssueTypeChart(validRows);
            updateResponsibleChart(validRows);
        }
        
        // Update dashboard table
        function updateDashboardTable(rows) {
            const tableBody = document.getElementById('dashboard-table-body');
            tableBody.innerHTML = '';
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                
                // Add cells
                tr.innerHTML = `
                    <td>${formatDisplayDate(row[0])}</td>
                    <td>${row[2] || '-'}</td>
                    <td>${row[3] || '-'}</td>
                    <td>${row[5] || '-'}</td>
                    <td>${row[6] || '-'}</td>
                    <td class="${getStatusClass(row[7])}">${row[7] || '-'}</td>
                    <td>${row[8] || '-'}</td>
                    <td>${formatDisplayDate(row[9]) || '-'}</td>
                `;
                
                tableBody.appendChild(tr);
            });
        }
        
        // Format display date (ensure DD/MM/YYYY format)
        function formatDisplayDate(dateStr) {
            if (!dateStr) return '';
            
            // If already in correct format, return as is
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                return dateStr;
            }
            
            // Try to parse date
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                
                const day = date.getDate();
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                return dateStr;
            }
        }
        
        // Get status class
        function getStatusClass(status) {
            if (!status) return '';
            
            switch (status) {
                case 'มอบหมายงาน':
                    return 'status-assigned';
                case 'รับงาน/กำลังดำเนินงาน':
                    return 'status-inprogress';
                case 'ดำเนินการเสร็จสิ้น':
                    return 'status-completed';
                default:
                    return '';
            }
        }
        
        // Update issue type chart
        function updateIssueTypeChart(rows) {
            // Count issues by type
            const issueTypes = {};
            rows.forEach(row => {
                const issue = row[2];
                if (issue) {
                    issueTypes[issue] = (issueTypes[issue] || 0) + 1;
                }
            });
            
            // Prepare chart data
            const labels = Object.keys(issueTypes);
            const data = Object.values(issueTypes);
            const backgroundColors = generateColors(labels.length);
            
            // Create or update chart
            const ctx = document.getElementById('issueTypeChart').getContext('2d');
            
            if (issueTypeChart) {
                issueTypeChart.data.labels = labels;
                issueTypeChart.data.datasets[0].data = data;
                issueTypeChart.data.datasets[0].backgroundColor = backgroundColors;
                issueTypeChart.update();
            } else {
                issueTypeChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 12,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Update responsible chart
        function updateResponsibleChart(rows) {
            // Count tasks by responsible person and status
            const responsibleData = {};
            
            rows.forEach(row => {
                const responsible = row[6] || 'ไม่ระบุ';
                const status = row[7] || 'ไม่ระบุ';
                
                if (!responsibleData[responsible]) {
                    responsibleData[responsible] = {
                        'มอบหมายงาน': 0,
                        'รับงาน/กำลังดำเนินงาน': 0,
                        'ดำเนินการเสร็จสิ้น': 0
                    };
                }
                
                if (status === 'มอบหมายงาน' || status === 'รับงาน/กำลังดำเนินงาน' || status === 'ดำเนินการเสร็จสิ้น') {
                    responsibleData[responsible][status]++;
                }
            });
            
            // Prepare chart data
            const labels = Object.keys(responsibleData);
            const assignedData = labels.map(label => responsibleData[label]['มอบหมายงาน']);
            const inProgressData = labels.map(label => responsibleData[label]['รับงาน/กำลังดำเนินงาน']);
            const completedData = labels.map(label => responsibleData[label]['ดำเนินการเสร็จสิ้น']);
            
            // Create or update chart
            const ctx = document.getElementById('responsibleChart').getContext('2d');
            
            if (responsibleChart) {
                responsibleChart.data.labels = labels;
                responsibleChart.data.datasets[0].data = assignedData;
                responsibleChart.data.datasets[1].data = inProgressData;
                responsibleChart.data.datasets[2].data = completedData;
                responsibleChart.update();
            } else {
                responsibleChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'มอบหมายงาน',
                                data: assignedData,
                                backgroundColor: '#fff2cc',
                                borderColor: '#ffd966',
                                borderWidth: 1
                            },
                            {
                                label: 'รับงาน/กำลังดำเนินงาน',
                                data: inProgressData,
                                backgroundColor: '#f8d7da',
                                borderColor: '#f5c2c7',
                                borderWidth: 1
                            },
                            {
                                label: 'ดำเนินการเสร็จสิ้น',
                                data: completedData,
                                backgroundColor: '#d4edda',
                                borderColor: '#c3e6cb',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                stacked: true,
                                beginAtZero: true
                            },
                            y: {
                                stacked: true
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.raw || 0;
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Generate colors for charts
        function generateColors(count) {
            const colors = [
                '#b8d8e8', '#ffcba4', '#f9f3e6', '#c7ceea', '#ffdac1', 
                '#e2f0cb', '#b5ead7', '#ff9aa2', '#c7f9cc', '#80ced6'
            ];
            
            // If we need more colors than in our palette, generate them
            if (count > colors.length) {
                for (let i = colors.length; i < count; i++) {
                    const r = Math.floor(Math.random() * 200 + 55);
                    const g = Math.floor(Math.random() * 200 + 55);
                    const b = Math.floor(Math.random() * 200 + 55);
                    colors.push(`rgba(${r}, ${g}, ${b}, 0.7)`);
                }
            }
            
            return colors.slice(0, count);
        }
        
        // Update task lists
        function updateTaskLists() {
            // Filter valid rows
            const validRows = sheetData.filter(row => {
                return row[0] && row[2] && row[3] && row[7]; // Check if date, issue, location, and status are not empty
            });
            
            // Split tasks by status
            const pendingTasks = validRows.filter(row => row[7] === 'มอบหมายงาน' || row[7] === 'รับงาน/กำลังดำเนินงาน');
            const completedTasks = validRows.filter(row => row[7] === 'ดำเนินการเสร็จสิ้น');
            
            // Update pending tasks table
            updatePendingTasksTable(pendingTasks);
            
            // Update completed tasks table
            updateCompletedTasksTable(completedTasks);
        }
        
        // Update pending tasks table
        function updatePendingTasksTable(tasks) {
            const tableBody = document.getElementById('pending-table-body');
            tableBody.innerHTML = '';
            
            tasks.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // Add cells
                tr.innerHTML = `
                    <td>${formatDisplayDate(row[0])}</td>
                    <td>${row[2] || '-'}</td>
                    <td>${row[3] || '-'}</td>
                    <td>${row[4] || '-'}</td>
                    <td>${row[5] || '-'}</td>
                    <td>${row[6] || '-'}</td>
                    <td class="${getStatusClass(row[7])}">${row[7] || '-'}</td>
                    <td>
                        ${row[7] === 'มอบหมายงาน' ? 
                            `<button class="accept-task-btn bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600 transition" data-row="${sheetData.indexOf(row)}">รับงาน</button>` : 
                            row[7] === 'รับงาน/กำลังดำเนินงาน' ? 
                            `<button class="complete-task-btn bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition" data-row="${sheetData.indexOf(row)}">ปิดงาน</button>` : 
                            '-'
                        }
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.accept-task-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = parseInt(this.dataset.row);
                    showTaskModal(row, 'accept');
                });
            });
            
            document.querySelectorAll('.complete-task-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = parseInt(this.dataset.row);
                    showTaskModal(row, 'complete');
                });
            });
        }
        
        // Update completed tasks table
        function updateCompletedTasksTable(tasks) {
            const tableBody = document.getElementById('completed-table-body');
            tableBody.innerHTML = '';
            
            tasks.forEach(row => {
                const tr = document.createElement('tr');
                
                // Add cells
                tr.innerHTML = `
                    <td>${formatDisplayDate(row[0])}</td>
                    <td>${row[2] || '-'}</td>
                    <td>${row[3] || '-'}</td>
                    <td>${row[6] || '-'}</td>
                    <td>${row[8] || '-'}</td>
                    <td>${formatDisplayDate(row[9]) || '-'}</td>
                    <td>${row[10] || '-'}</td>
                    <td>${row[11] || '-'}</td>
                `;
                
                tableBody.appendChild(tr);
            });
        }
        
        // Update filters
        function updateFilters() {
            // Get unique issue types
            const issueTypes = new Set();
            sheetData.forEach(row => {
                if (row[2]) {
                    issueTypes.add(row[2]);
                }
            });
            
            // Update issue filter
            const issueFilter = document.getElementById('filter-issue');
            const currentValue = issueFilter.value;
            issueFilter.innerHTML = '<option value="">เลือกประเภทงาน</option>';
            
            Array.from(issueTypes).sort().forEach(issue => {
                const option = document.createElement('option');
                option.value = issue;
                option.textContent = issue;
                issueFilter.appendChild(option);
            });
            
            // Restore selected value if it still exists
            if (currentValue && Array.from(issueTypes).includes(currentValue)) {
                issueFilter.value = currentValue;
            }
        }
        
        // Apply filters
        function applyFilters() {
            const dateFilter = document.getElementById('filter-date').value;
            const issueFilter = document.getElementById('filter-issue').value;
            
            // Filter valid rows
            let filteredRows = sheetData.filter(row => {
                return row[0] && row[2] && row[3] && row[7]; // Check if date, issue, location, and status are not empty
            });
            
            // Apply date filter
            if (dateFilter) {
                const filterDate = new Date(dateFilter);
                filteredRows = filteredRows.filter(row => {
                    try {
                        // Parse date from DD/MM/YYYY format
                        const parts = row[0].split('/');
                        if (parts.length !== 3) return false;
                        
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1;
                        const year = parseInt(parts[2]);
                        
                        const rowDate = new Date(year, month, day);
                        
                        return rowDate.getDate() === filterDate.getDate() &&
                               rowDate.getMonth() === filterDate.getMonth() &&
                               rowDate.getFullYear() === filterDate.getFullYear();
                    } catch (e) {
                        return false;
                    }
                });
            }
            
            // Apply issue filter
            if (issueFilter) {
                filteredRows = filteredRows.filter(row => row[2] === issueFilter);
            }
            
            // Update dashboard table with filtered data
            updateDashboardTable(filteredRows);
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('filter-date').value = '';
            document.getElementById('filter-issue').value = '';
            
            // Show all valid rows
            const validRows = sheetData.filter(row => {
                return row[0] && row[2] && row[3] && row[7]; // Check if date, issue, location, and status are not empty
            });
            
            updateDashboardTable(validRows);
        }
        
        // Update task status
        function updateTaskStatus(rowIndex, status) {
            // Show loading indicator
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Update local data
            sheetData[rowIndex][7] = status;
            
            // Prepare data for API
            const settings = loadSettings();
            const data = {
                action: 'updateCell',
                sheetId: settings.sheetId,
                sheetName: settings.sheetName,
                row: rowIndex + 2, // Convert to 1-based index and account for header row
                column: 'H', // Status column
                value: status
            };
            
            // Send update to Google Sheets
            fetch(settings.appScriptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Update UI
                    updateDashboard();
                    updateTaskLists();
                    
                    // Show success message
                    Swal.fire({
                        title: 'บันทึกข้อมูลสำเร็จ',
                        text: `สถานะงานถูกเปลี่ยนเป็น "${status}" เรียบร้อยแล้ว`,
                        icon: 'success',
                        confirmButtonColor: '#5a9bc7'
                    });
                } else {
                    throw new Error(result.error || 'Failed to update data');
                }
            })
            .catch(error => {
                console.error('Error updating task status:', error);
                
                // Show error message
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
                    icon: 'error',
                    confirmButtonColor: '#5a9bc7'
                });
                
                // For demo purposes, still update the UI
                updateDashboard();
                updateTaskLists();
            });
        }
        
        // Update task completion
        function updateTaskCompletion(rowIndex, result, dateStr, timeStr, note) {
            // Show loading indicator
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Update local data
            sheetData[rowIndex][7] = 'ดำเนินการเสร็จสิ้น'; // Status
            sheetData[rowIndex][8] = result; // Result
            sheetData[rowIndex][9] = dateStr; // Completion date
            sheetData[rowIndex][10] = timeStr; // Completion time
            sheetData[rowIndex][11] = note; // Note
            
            // Prepare data for API
            const settings = loadSettings();
            const data = {
                action: 'updateTask',
                sheetId: settings.sheetId,
                sheetName: settings.sheetName,
                row: rowIndex + 2, // Convert to 1-based index and account for header row
                status: 'ดำเนินการเสร็จสิ้น',
                result: result,
                completionDate: dateStr,
                completionTime: timeStr,
                note: note
            };
            
            // Send update to Google Sheets
            fetch(settings.appScriptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Update UI
                    updateDashboard();
                    updateTaskLists();
                    
                    // Show success message
                    Swal.fire({
                        title: 'บันทึกข้อมูลสำเร็จ',
                        text: 'งานถูกปิดเรียบร้อยแล้ว',
                        icon: 'success',
                        confirmButtonColor: '#5a9bc7'
                    });
                } else {
                    throw new Error(result.error || 'Failed to update data');
                }
            })
            .catch(error => {
                console.error('Error completing task:', error);
                
                // Show error message
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
                    icon: 'error',
                    confirmButtonColor: '#5a9bc7'
                });
                
                // For demo purposes, still update the UI
                updateDashboard();
                updateTaskLists();
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'95bc992c371b7334',t:'MTc1MTk0NjQyNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
